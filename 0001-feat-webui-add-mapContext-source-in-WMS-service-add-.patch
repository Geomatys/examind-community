From 8cb434bafe88303ec8a75156b82927fab086dd14 Mon Sep 17 00:00:00 2001
From: Hilmi BOUALLAGUE <hilmi.bouallegue@geomatys.com>
Date: Mon, 12 Oct 2020 19:28:08 +0200
Subject: [PATCH] feat(webui): add mapContext source in WMS service add data

---
 .../exa-webui/grunt/src/i18n/en/ui.json       |   2 +-
 .../exa-webui/grunt/src/i18n/fr/ui.json       |   2 +-
 .../src/js/webservice/webservice-edit.js      | 372 ++++++++++++++++++
 .../grunt/src/views/webservice/edit.html      |  12 +-
 .../views/webservice/wms/modalAddLayer.html   | 165 ++++++++
 .../grunt/src/views/webservice/wms/step1.html |  35 ++
 .../views/webservice/wms/step2_internal.html  | 177 +++++++++
 .../webservice/wms/step2_mapcontext.html      | 134 +++++++
 8 files changed, 896 insertions(+), 3 deletions(-)
 create mode 100644 modules/bundles/exa-webui/grunt/src/views/webservice/wms/modalAddLayer.html
 create mode 100644 modules/bundles/exa-webui/grunt/src/views/webservice/wms/step1.html
 create mode 100644 modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_internal.html
 create mode 100644 modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_mapcontext.html

diff --git a/modules/bundles/exa-webui/grunt/src/i18n/en/ui.json b/modules/bundles/exa-webui/grunt/src/i18n/en/ui.json
index e5cf98946c..63230fec00 100644
--- a/modules/bundles/exa-webui/grunt/src/i18n/en/ui.json
+++ b/modules/bundles/exa-webui/grunt/src/i18n/en/ui.json
@@ -1179,7 +1179,7 @@
   "service.edit.dashboard.wmts.select.byMapcontext": "Map context",
   "service.edit.dashboard.wmts.select.byInternalData.title": "Create new layer from data layers",
   "service.edit.dashboard.wmts.select.byMapcontext.title": "Create layer from map context",
-  "service.edit.dashboard.wmts.select.fillName": "Enter WMTS layer name",
+  "service.edit.dashboard.wmts.select.fillName": "Enter layer name",
   "service.edit.dashboard.wmts.select.layerName": "Layer name",
   "service.edit.dashboard.wmts.validation.name": "The name is required and should not contain any special characters or space characters.",
   "service.edit.dashboard.wmts.validation.nameExists": "The layer name already exists",
diff --git a/modules/bundles/exa-webui/grunt/src/i18n/fr/ui.json b/modules/bundles/exa-webui/grunt/src/i18n/fr/ui.json
index 9e8a911606..96d9b71c6c 100644
--- a/modules/bundles/exa-webui/grunt/src/i18n/fr/ui.json
+++ b/modules/bundles/exa-webui/grunt/src/i18n/fr/ui.json
@@ -1292,7 +1292,7 @@
   "service.edit.dashboard.wmts.select.byMapcontext": "Composition cartographique",
   "service.edit.dashboard.wmts.select.byInternalData.title": "Créer une couche à partir des données",
   "service.edit.dashboard.wmts.select.byMapcontext.title": "Créer une couche à partir d'une composition cartographique",
-  "service.edit.dashboard.wmts.select.fillName": "Donner un nom à la couche WMTS",
+  "service.edit.dashboard.wmts.select.fillName": "Donner un nom à la couche de données",
   "service.edit.dashboard.wmts.select.layerName": "Nom de la couche",
   "service.edit.dashboard.wmts.validation.name": "Le nom est obligatoire et ne doit pas contenir de caractères spéciaux ou des espaces.",
   "service.edit.dashboard.wmts.validation.nameExists": "Le nom de couche existe déjà.",
diff --git a/modules/bundles/exa-webui/grunt/src/js/webservice/webservice-edit.js b/modules/bundles/exa-webui/grunt/src/js/webservice/webservice-edit.js
index f5bc38d49f..9718f158bd 100644
--- a/modules/bundles/exa-webui/grunt/src/js/webservice/webservice-edit.js
+++ b/modules/bundles/exa-webui/grunt/src/js/webservice/webservice-edit.js
@@ -335,6 +335,30 @@ angular.module('cstl-webservice-edit', [
             });
         };
 
+        $scope.showDataToAddWMS = function() {
+            var modal = $modal.open({
+                templateUrl: 'views/webservice/wms/modalAddLayer.html',
+                controller: 'WMSAddLayerModalController',
+                resolve: {
+                    service: function() { return $scope.service; },
+                    epsgCodes: function(Examind) {
+                        return Examind.crs.listAll();
+                    }
+                }
+            });
+            modal.result.then(function() {
+                Examind.map.getLayers($scope.type,
+                    $routeParams.id).then(
+                    function (response) {//success
+                        $scope.layers = response.data;
+                        Dashboard($scope, response.data, true);
+                        $scope.selected = null;
+                        $scope.showLayerDashboardMap();
+                    }
+                );
+            });
+        };
+
         $scope.showDataToAddWMTS = function() {
             var modal = $modal.open({
                 templateUrl: 'views/webservice/wmts/modalAddLayer.html',
@@ -1026,7 +1050,206 @@ angular.module('cstl-webservice-edit', [
         };
 
     })
+    .controller('WMSAddLayerModalController', function($scope, $modalInstance, service,
+                                                        Growl, Examind, epsgCodes) {
+        var DEFAULT_PROJECTION = {
+            code:"EPSG:3857",
+            desc:"3857 - WGS 84 / Pseudo-Mercator"
+        };
+        $scope.service = service;
+        $scope.values = {
+            epsgList : epsgCodes.data,
+            selectedProjection : DEFAULT_PROJECTION,
+            listSelect : [],
+            selectedSensor : null,
+            selectedSensorsChild : null,
+            userLayerName : '',
+            listWMSLayers : [],
+            selectedContext : null
+        };
+
+        // handle display mode for this modal popup
+        $scope.mode = {
+            display: 'sourceSelection',
+            previous: undefined
+        };
+
+        $scope.dataSelect = {
+            all : false,
+            mergeData : false
+        };
+
+        $scope.wrap = {};
+
+        $scope.wrap.nbbypage = 5;
+
+        /**
+         * function to add data to service
+         */
+        $scope.choose = function() {
+            if ($scope.values.listSelect.length === 0) {
+                Growl('warning', 'Warning', 'No data selected!');
+                return;
+            }
+            // Aggregation of data in one single layer
+            if($scope.dataSelect.mergeData) {
+                var crs = "EPSG:3857";
+                var dataIds = $scope.values.listSelect.map(function (data) {
+                    return data.id;
+                });
+                if(!$scope.values.userLayerName) {
+                    $scope.values.userLayerName = $scope.values.listSelect[0].name;
+                }
+                Examind.datas.pyramidData(crs, $scope.values.userLayerName, dataIds).then(
+                    function(response){//success
+                        response = response.data;
+                        if(response.dataId && response.providerId) {
+                            Examind.map.addLayer($scope.service.type, $scope.service.identifier,
+                                {layerAlias: response.dataId,
+                                    layerId: response.dataId,
+                                    serviceType: $scope.service.type,
+                                    serviceId: $scope.service.identifier,
+                                    providerId: response.providerId}).then(
+                                function () {//success
+                                    Growl('success','Success','Layer successfully added to service '+$scope.service.name);
+                                    $scope.close();
+                                },
+                                function () {
+                                    Growl('error','Error','Layer failed to be added to service '+$scope.service.name);
+                                    $scope.dismiss();
+                                }
+                            );
+                        }
+                    },function(){//error
+                        Growl('error', 'Error', 'Failed to generate pyramid data');
+                    }
+                );
+            } else {
+                //using angular.forEach to avoid jsHint warning when declaring function in loop
+                angular.forEach($scope.values.listSelect, function(value){
+                    var providerId = value.provider;
+                    providerId = value.pyramidConformProviderId?value.pyramidConformProviderId:value.provider;
+                    Examind.map.addLayer($scope.service.type, $scope.service.identifier,
+                        {layerAlias: value.name,
+                            layerId: value.name,
+                            serviceType: $scope.service.type,
+                            serviceId: $scope.service.identifier,
+                            providerId: providerId,
+                            layerNamespace: value.namespace}).then(
+                        function(response) {//on success
+                            Growl('success', 'Success', response.data.message);
+                            $scope.close();
+                        },
+                        function(err) {//on error
+                            Growl('error', 'Error', err.data.message);
+                            $scope.dismiss();
+                        }
+                    );
+                });
+            }
+        };
+
+        $scope.goToLastStep = function() {
+            //get all layers in this wmts service to compare for existing layer names.
+            Examind.map.getLayers($scope.service.type,
+                $scope.service.identifier).then(
+                function (response) {//success
+                    $scope.values.listWMSLayers = response.data;
+                    if($scope.mode.display==='internal' && $scope.values.userLayerName === '' && $scope.values.listSelect.length===1){
+                        //set the layerName for singleton list
+                        var name = $scope.values.listSelect[0].name;
+                        if(!checkLayerName(name+'_pyramid')){
+                            $scope.values.userLayerName = name+'_pyramid';
+                        }else {
+                            $scope.values.userLayerName = '';
+                        }
+                    }else {
+                        $scope.values.userLayerName = '';
+                    }
+                    $scope.mode.previous=$scope.mode.display;
+                    $scope.mode.display='lastStep';
+                },function(){//error
+                    Growl('warning', 'Warning', 'An error occurred!');
+                }
+            );
+        };
+
+        function checkLayerName(name) {
+            if(name && name.length>0 &&
+                $scope.values.listWMSLayers && $scope.values.listWMSLayers.length>0){
+                for(var i=0;i<$scope.values.listWMSLayers.length;i++){
+                    var lay=$scope.values.listWMSLayers[i];
+                    if(lay.name === name || lay.alias === name) {
+                        return true;
+                    }
+                }
+            }
+            return false;
+        }
+
+        $scope.submitWMSLayer = function () {
+            if ($scope.values.selectedProjection && $scope.values.selectedProjection.code) {
+                $scope.crs = $scope.values.selectedProjection.code;
+            } else {
+                $scope.values.selectedProjection = DEFAULT_PROJECTION;
+            }
+            if ($scope.values.selectedContext === null) {
+                Growl('warning', 'Warning', 'No map context selected!');
+                return;
+            }
+            Examind.mapcontexts.pyramidMapContext($scope.values.selectedContext.id,
+                $scope.crs,
+                $scope.values.userLayerName).then(
+                function (response) {//on success
+                    response = response.data;
+                    if (response.dataId && response.providerId) {
+                        Examind.map.addLayer($scope.service.type, $scope.service.identifier,
+                            {
+                                layerAlias: response.dataId,
+                                layerId: response.dataId,
+                                serviceType: $scope.service.type,
+                                serviceId: $scope.service.identifier,
+                                providerId: response.providerId
+                            }).then(
+                            function () {//success
+                                Growl('success', 'Success', 'Layer successfully added to service ' + $scope.service.name);
+                                $scope.close();
+                            },
+                            function () {
+                                Growl('error', 'Error', 'Layer failed to be added to service ' + $scope.service.name);
+                                $scope.dismiss();
+                            }
+                        );
+                    }
+                },
+                function () {//on error
+                    Growl('error', 'Error', 'Failed to generate pyramid data');
+                }
+            );
+        };
+
+        $scope.isValidWMSLayerName = function(){
+            var letters = /^[A-Za-zàèìòùáéíóúäëïöüñãõåæøâêîôû0-9\-_]+$/;
+            var name = $scope.values.userLayerName;
+            var passRegEx = false;
+            if(name && name.match(letters)) {
+                passRegEx = true;
+            }
+            return passRegEx;
+        };
+
+        $scope.isLayerNameExists = function() {
+            return checkLayerName($scope.values.userLayerName);
+        };
+
+        $scope.dismiss = function() {
+            $modalInstance.dismiss('close');
+        };
 
+        $scope.close = function() {
+            $modalInstance.close();
+        };
+    })
     .controller('Step1WMTSInternalDataController', function($scope, Dashboard,
                                                             Examind, $cookieStore,$filter) {
         /**
@@ -1179,6 +1402,155 @@ angular.module('cstl-webservice-edit', [
 
         $scope.initInternalDataWMTS();
     })
+    /**
+     * Controller of WMS internal data
+     */
+    .controller('Step1WMSInternalDataController', function($scope, Dashboard, Growl, Examind, $cookieStore, $filter) {
+        /**
+         * To fix angular bug with nested scope.
+         */
+
+
+        $scope.clickFilter = function(ordType){
+            $scope.wrap.ordertype = ordType;
+            $scope.wrap.orderreverse = !$scope.wrap.orderreverse;
+        };
+
+        $scope.initInternalDataWMS = function() {
+            Examind.datas.getDataListLight(false).then(function (response) {
+                var dataList = response.data;
+                Dashboard($scope, dataList, false);
+            });
+            setTimeout(function(){
+                $scope.previewData();
+            },300);
+        };
+
+        $scope.previewData = function() {
+            //clear the map
+            if (DataViewer.map) {
+                DataViewer.map.setTarget(undefined);
+            }
+            var cstlUrl = $cookieStore.get('cstlUrl');
+            DataViewer.initConfig();
+            if($scope.values.listSelect.length >0){
+                var layerName,providerId;
+                for(var i=0;i<$scope.values.listSelect.length;i++){
+                    var dataItem = $scope.values.listSelect[i];
+                    if (dataItem.namespace) {
+                        layerName = '{' + dataItem.namespace + '}' + dataItem.name;
+                    } else {
+                        layerName = dataItem.name;
+                    }
+                    providerId = dataItem.provider;
+                    var layerData;
+                    var type = dataItem.type?dataItem.type.toLowerCase():null;
+                    if (dataItem.targetStyle && dataItem.targetStyle.length > 0) {
+                        layerData = DataViewer.createLayerWithStyle(cstlUrl,dataItem.id,layerName,
+                            dataItem.targetStyle[0].name,null,null,type!=='vector');
+                    } else {
+                        layerData = DataViewer.createLayer(cstlUrl,dataItem.id,layerName,null,type!=='vector');
+                    }
+                    //to force the browser cache reloading styled layer.
+                    layerData.get('params').ts=new Date().getTime();
+                    DataViewer.layers.push(layerData);
+                }
+                var dataIds = $scope.values.listSelect.map(function (value) {
+                    return value.id;
+                });
+                Examind.datas.mergedDataExtent(dataIds).then(
+                    function(response) {// on success
+                        DataViewer.initMap('styledMapPreviewForWMTS');
+                        if(response.data && response.data.boundingBox) {
+                            var bbox = response.data.boundingBox;
+                            var extent = [bbox[0],bbox[1],bbox[2],bbox[3]];
+                            DataViewer.zoomToExtent(extent,DataViewer.map.getSize(),false);
+                        }
+                    }, function() {//on error
+                        // failed to calculate an extent, just load the full map
+                        DataViewer.initMap('styledMapPreviewForWMTS');
+                    }
+                );
+            }else {
+                DataViewer.initMap('styledMapPreviewForWMTS');
+                DataViewer.map.getView().setZoom(DataViewer.map.getView().getZoom()+1);
+            }
+        };
+
+        /**
+         * Proceed to select all items of dashboard
+         * depending on the property binded to checkbox.
+         */
+        $scope.selectAllData = function() {
+            var array = $filter('filter')($scope.wrap.fullList, {'type':$scope.wrap.filtertype, '$': $scope.wrap.filtertext},$scope.wrap.matchExactly);
+            $scope.values.listSelect = ($scope.dataSelect.all) ? array.slice(0) : [];
+            $scope.previewData();
+        };
+        /**
+         * binding call when clicking on each row item.
+         */
+        $scope.toggleDataInArray = function(item){
+            var itemExists = false;
+            for (var i = 0; i < $scope.values.listSelect.length; i++) {
+                if ($scope.values.listSelect[i].id === item.id) {
+                    itemExists = true;
+                    $scope.values.listSelect.splice(i, 1);//remove item
+                    break;
+                }
+            }
+            if(!itemExists){
+                $scope.values.listSelect.push(item);
+            }
+            $scope.dataSelect.all=($scope.values.listSelect.length === $scope.wrap.fullList.length);
+            $scope.previewData();
+
+        };
+        /**
+         * Returns true if item is in the selected items list.
+         * binding function for css purposes.
+         * @param item
+         * @returns {boolean}
+         */
+        $scope.isInSelected = function(item){
+            for(var i=0; i < $scope.values.listSelect.length; i++){
+                if($scope.values.listSelect[i].id === item.id){
+                    return true;
+                }
+            }
+            return false;
+        };
+
+        $scope.setTargetStyle = function(data,index) {
+            var tmp = data.targetStyle.splice(index,1);
+            data.targetStyle.unshift(tmp[0]);
+            $scope.previewData();
+        };
+
+        /**
+         * truncate text with JS.
+         * Why not use CSS for this?
+         *
+         * css rule is
+         * {
+         *  width: 100px
+         *  white-space: nowrap
+         *  overflow: hidden
+         *  text-overflow: ellipsis // This is where the magic happens
+         *  }
+         *
+         * @param text
+         * @param length
+         * @returns {string}
+         */
+        $scope.truncate = function(text,length){
+            if(text) {
+                return (text.length > length) ? text.substr(0, length) + "..." : text;
+            }
+        };
+
+        $scope.initInternalDataWMS();
+
+    })
 
     .controller('Step1WMTSMapContextController', function($scope, Dashboard,Growl, $cookieStore, Examind) {
         /**
diff --git a/modules/bundles/exa-webui/grunt/src/views/webservice/edit.html b/modules/bundles/exa-webui/grunt/src/views/webservice/edit.html
index f36823f247..6bc68d08d0 100644
--- a/modules/bundles/exa-webui/grunt/src/views/webservice/edit.html
+++ b/modules/bundles/exa-webui/grunt/src/views/webservice/edit.html
@@ -440,7 +440,7 @@
                             </div>
                         </div>
                             <div id="block-information-right" class="col-sm-4">
-                                <div ng-if="service.type !== 'csw' && service.type !== 'wmts' && service.type !== 'tms'">
+                                <div ng-if="service.type !== 'csw' && service.type !== 'wmts' && service.type !== 'tms' && service.type !== 'wms'">
                                     <a data-toggle="modal"
                                        class="btn btn-add btn-lg btn-block"
                                        ng-click="showDataToAdd()" id="showDataToAdd">
@@ -449,6 +449,16 @@
                                         <span translate="service.edit.dashboard.action.add.button">Add</span>
                                     </a>
                                 </div>
+                                <div ng-if="service.type.toLowerCase() === 'wms'">
+                                    <a id="showDataToAddWMS"
+                                       data-toggle="modal"
+                                       class="btn btn-add btn-lg btn-block"
+                                       ng-click="showDataToAddWMS()">
+                                        <span class="fa fa-plus"
+                                              style="margin-right:5px;"></span>
+                                        <span translate="service.edit.dashboard.wmts.action.addnewlayer.button">Add</span>
+                                    </a>
+                                </div>
                                 <div ng-if="service.type.toLowerCase() === 'wmts'">
                                     <a id="showDataToAddWMTS"
                                        data-toggle="modal"
diff --git a/modules/bundles/exa-webui/grunt/src/views/webservice/wms/modalAddLayer.html b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/modalAddLayer.html
new file mode 100644
index 0000000000..b9c32cea67
--- /dev/null
+++ b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/modalAddLayer.html
@@ -0,0 +1,165 @@
+<div id="chooseDataModalWMTS" class="modal-dialog modal-dialog-resp-height"
+     ng-class="{'modal-dialog-sld':mode.display==='internal' || mode.display==='mapcontext'}">
+    <div class="modal-content">
+        <div class="modal-header">
+            <button type="button" class="close" ng-click="dismiss()">×</button>
+            <h4 class="modal-title"
+                ng-if="mode.display==='sourceSelection'"
+                translate="service.edit.dashboard.wmts.select.source">Select how to build the layer</h4>
+            <h4 ng-if="mode.display==='internal'"
+                class="modal-title"
+                translate="service.edit.dashboard.wmts.select.internal">Select one or more data in the list</h4>
+            <h4 ng-if="mode.display==='mapcontext'"
+                class="modal-title"
+                translate="service.edit.dashboard.wmts.select.mapcontext">Select one mapcontext in the list</h4>
+            <h4 ng-if="mode.display==='lastStep'"
+                class="modal-title"
+                translate="service.edit.dashboard.wmts.select.fillName">Enter WMTS layer name</h4>
+        </div>
+        <div class="modal-body modal-body-style">
+            <div ng-if="mode.display==='sourceSelection'">
+                <div ng-include="'views/webservice/wms/step1.html'"></div>
+            </div>
+            <div ng-if="mode.display==='internal'">
+                <div ng-include="'views/webservice/wms/step2_internal.html'"></div>
+            </div>
+            <div ng-if="mode.display==='mapcontext'">
+                <div ng-include="'views/webservice/wms/step2_mapcontext.html'"></div>
+            </div>
+            <div ng-if="mode.display==='lastStep'">
+                <form class="form-horizontal" style="margin:18px;" id="laststepform" name="laststepform">
+                    <div class="form-group">
+                        <label class="col-sm-4 col-md-4 control-label"
+                               style="color: #ddd"
+                               translate="service.edit.dashboard.wmts.select.layerName">Layer name</label>
+                        <div class="col-sm-7">
+                            <input type="text"
+                                   class="form-control form-control-fix"
+                                   ng-class="{'highlight-invalid':!isValidWMTSLayerName()}"
+                                   ng-model="values.userLayerName"
+                                   debounce="200"
+                                   ng-required="true"
+                                   placeholder="{{'service.edit.dashboard.wmts.select.fillName' | translate}}"
+                                   name="layerNameField"/>
+                            <div ng-if="!isValidWMTSLayerName()"
+                                 class="col-xs-12 col-sm-12 col-md-12 col-lg-12 control-error animate">
+                                <i class="fa fa-caret-up"></i>
+                                <span translate="service.edit.dashboard.wmts.validation.name">The name is required and should not contain any special characters or space characters.</span>
+                            </div>
+                            <div ng-if="isLayerNameExists()"
+                                 class="col-xs-12 col-sm-12 col-md-12 col-lg-12 control-error animate">
+                                <i class="fa fa-caret-up"></i>
+                                <span translate="service.edit.dashboard.wmts.validation.nameExists">The layer name already exists.</span>
+                            </div>
+                        </div>
+                    </div>
+                    <div class="form-group" ng-if="canShowUseExistingPyramid()">
+                        <label class="col-sm-4 col-md-4 control-label"
+                               style="color: #ddd">
+                            {{'service.edit.dashboard.wmts.use.existing.pyramid' | translate}}
+                        </label>
+                        <div class="col-sm-7">
+                            <input type="checkbox" ng-click="listcrs()">
+                        </div>
+                    </div>
+
+                    <div class="form-group" ng-if="!pyramidFlag">
+                        <label class="col-sm-4 col-md-4 control-label"
+                               style="color: #ddd"
+                               translate="layer.listing.data.upload.selectEPSG">Select projection</label>
+                        <div class="col-sm-7">
+                            <input type="text"
+                                   ng-model="values.selectedProjection"
+                                   typeahead="crs as crs.desc for crs in values.epsgList | filter:{desc:$viewValue} | limitTo:8"
+                                   class="form-control"
+                                   placeholder="{{'layer.listing.data.upload.typeEPSG' | translate}}"/>
+                            <div ng-if="values.selectedProjection.code != '3857'"
+                                 class="col-xs-12 col-sm-12 col-md-12 col-lg-12 control-warning animate">
+                                <i class="fa fa-warning"></i>
+                                <span translate="service.edit.dashboard.wmts.warning.projectionChange"></span>
+                            </div>
+                        </div>
+                    </div>
+
+                    <div class="form-group"
+                         ng-if="mode.previous ==='internal' && values.listSelect.length === 1 && pyramidFlag">
+                        <label class="col-sm-4 col-md-4 control-label"
+                               style="color: #ddd">{{'service.edit.dashboard.wmts.available.projection' | translate}}</label>
+                        <div class="col-sm-7">
+                            <select ng-model="existingPyramidCRS.code" class="form-control">
+                                <option ng-repeat="option in crsList" ng-value="option"
+                                        ng-selected="existingPyramidCRS.code === option">
+                                    {{option}}
+                                </option>
+                            </select>
+                        </div>
+                    </div>
+                </form>
+            </div>
+        </div>
+        <div class="modal-footer modal-footer-list-data">
+            <div class="pull-left col-xs-6"
+                 ng-if="mode.display==='internal' && values.listSelect.length>1"
+                 style="color:#ddd;padding:0;">
+                <div style="padding:0;width: 100%">
+                    <label class="pull-left">
+                        <input type="checkbox" ng-model="dataSelect.mergeData"/>
+                        <span>{{'service.layer.merge' | translate}}</span>
+                    </label>
+                </div>
+                <div class="col-xs-6"
+                     ng-if="dataSelect.mergeData"
+                     style="padding:0;">
+                    <label class="pull-left">
+                        <span>{{'service.edit.dashboard.wmts.select.layerName' | translate}}</span>
+                        <input type="text"
+                               style="width: 160px;display: inline;"
+                               class="form-control form-control-fix"
+                               ng-model="values.userLayerName"/>
+                    </label>
+                </div>
+            </div>
+            <div class="col-xs-6 pull-right">
+                <button type="button"
+                        class="btn btn-default"
+                        ng-click="dismiss()"
+                        translate="label.close">Close
+                </button>
+                <button type="button"
+                        ng-if="mode.display==='internal' || mode.display==='mapcontext'"
+                        class="btn btn-default"
+                        ng-click="mode.display='sourceSelection'"
+                        translate="label.previous">Previous
+                </button>
+                <button type="button"
+                        ng-if="mode.display==='lastStep'"
+                        class="btn btn-default"
+                        ng-click="mode.display=mode.previous;mode.previous='lastStep';"
+                        translate="label.previous">Previous
+                </button>
+
+                <button type="button"
+                        ng-if="mode.display==='mapcontext' && values.selectedContext"
+                        class="btn btn-add"
+                        ng-click="goToLastStep()"
+                        translate="label.next">Next
+                </button>
+
+                <button id="chooseButton"
+                        type="button"
+                        class="btn btn-add"
+                        ng-click="choose()"
+                        ng-if="mode.display==='internal'"
+                        translate="data.modal.choose">Choose
+                </button>
+
+                <button id="submitWMSLayer"
+                        ng-if="mode.display=='lastStep' && isValidWMSLayerName() && values.userLayerName.length>0 && !isLayerNameExists()"
+                        type="button"
+                        class="btn btn-add"
+                        ng-click="submitWMSLayer()"
+                        translate="label.finish">Finish</button>
+            </div>
+        </div>
+    </div>
+</div>
diff --git a/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step1.html b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step1.html
new file mode 100644
index 0000000000..7320cfc987
--- /dev/null
+++ b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step1.html
@@ -0,0 +1,35 @@
+<div style="margin-left:0; margin-right:0; height: 150px; padding-top: 22px;margin-bottom: 20px;">
+    <div class="col-sm-4 col-sm-offset-2"
+         style="text-align:center;">
+        <label class="radio data-type-choose"
+               style="height: 120px;"
+               title="{{'service.edit.dashboard.wmts.select.byInternalData.title' | translate}}">
+            <div class="col-sm-12"
+                 style="margin-top: 5px; padding-left:5px;">
+                <img src="img/wmts-internaldata.svg" />
+            </div>
+            <input type="radio"
+                   ng-model="mode.display"
+                   value="internal"
+                   style="display: none;"/>
+            <div translate="service.edit.dashboard.wmts.select.byInternalData"
+                 style="margin-top:10px;">By internal data</div> 
+        </label>
+    </div>
+    <div class="col-sm-4"
+         style="text-align:center;">
+        <label class="radio data-type-choose"
+               style="height: 120px;"
+               title="{{'service.edit.dashboard.wmts.select.byMapcontext.title' | translate}}">
+            <div class="col-sm-12" style="margin-top: 5px;">
+                <img src="img/wmts-mapcontext.svg" />
+            </div>
+            <input type="radio"
+                   ng-model="mode.display"
+                   value="mapcontext"
+                   style="display: none;"/>
+            <div translate="service.edit.dashboard.wmts.select.byMapcontext"
+                 style="margin-top:10px;">By map context</div>
+        </label>
+    </div>
+</div>
\ No newline at end of file
diff --git a/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_internal.html b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_internal.html
new file mode 100644
index 0000000000..b717a58123
--- /dev/null
+++ b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_internal.html
@@ -0,0 +1,177 @@
+<div class="row" ng-controller="Step1WMSInternalDataController">
+    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-left: 0;padding-right: 0;">
+        <div class="dashboard dashboard-wmts-internal list-style-modal">
+            <div class="navbar sort-navbar" style="margin-bottom: 6px;">
+                <div class="navbar-inner" style="padding-right: 10px;">
+                    <ul class="nav nav-style">
+                        <li ng-click="clickFilter('name')">
+                            <a style="padding:10px;">
+                                <span translate="label.title">Title</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'name' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'name' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                        <li ng-click="clickFilter('date')">
+                            <a style="padding:10px;">
+                                <span translate="service.edit.dashboard.header.date">Date</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'date' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'date' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                        <li ng-click="clickFilter('owner')">
+                            <a style="padding:10px;">
+                                <span translate="service.edit.dashboard.header.owner">Owner</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'owner' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'owner' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                        <li ng-click="clickFilter('type')">
+                            <a style="padding:10px;">
+                                <span translate="service.edit.dashboard.header.type">Type</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'type' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'type' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                    </ul>
+                    <button type="button" ng-click="wrap.ordertype='name';wrap.orderreverse=false" class="btn btn-xs btn-data">
+                        <i class="fa fa-times"></i>
+                    </button>
+                    <button type="button" ng-click="searchVisible= !searchVisible" class="btn btn-xs btn-data">
+                        <i class="fa fa-search"></i>
+                    </button>
+                    <div class="pull-right col-xs-7 col-sm-7 col-md-3 col-lg-4"
+                         style="padding-left:10px;padding-right:0;"
+                         ng-if="searchVisible">
+                        <div style="position:relative;">
+                            <input type="text"
+                                   ng-model="wrap.filtertext"
+                                   class="search-query form-control form-control-fix"
+                                   style="height: 30px;"
+                                   placeholder="{{'label.search' | translate}}" />
+                        </div>
+                    </div>
+                </div>
+            </div>
+            <div class="dash-inner modal-inner-list" style="padding: 0">
+                <div id="list" data-role="list" style="height: 100%;">
+                    <div class="pagination-wrapper pagination-data">
+                        <div class="col-xs-12" style="padding: 0;">
+                            <strong class="col-xs-8" style="padding-right: 0;">
+                                <span class="nb-results pull-left">{{wrap.countdata}}&nbsp;</span>
+                                <span class="nb-results" translate="label.count.data">available data</span>
+                            </strong>
+                            <div class="pull-right col-xs-4" style="padding-right:0;padding-left: 0">
+                                <input type="checkbox"
+                                       ng-model="dataSelect.all"
+                                       id="selectAll"
+                                       ng-change="selectAllData()"/>
+                                <span style="color:#ccc;" translate="label.select.all">Select all</span>
+                            </div>
+                        </div>
+                        <div class="row" style="margin-left: 0; margin-right: 0;">
+                            <div class="col-sm-9" style="padding:0; margin-top: 5px;"
+                                 page-switcher="{page:wrap.currentpage,size:wrap.nbbypage,count:wrap.countdata}"
+                                 on-select-page="displayPage(page)"></div>
+                            <select class="nb-per-page input-small form-control pull-right col-xs-2 "
+                                    style="padding:5px;margin-right:0;margin-top:5px;"
+                                    ng-model="wrap.nbbypage">
+                                <option value="5">5</option>
+                                <option value="10">10</option>
+                                <option value="20">20</option>
+                                <option value="50">50</option>
+                                <option value="100">100</option>
+                            </select>
+                        </div>
+                    </div>
+                    <div class="item-list">
+                        <div ng-repeat="data in wrap.dataList"
+                             ng-if="data.type === 'VECTOR' || data.type === 'COVERAGE'">
+                            <div class="item {{data.type | lowercase}}"
+                                 ng-class="{selected:isInSelected(data)}"
+                                 ng-click="toggleDataInArray(data)"
+                                 data-name="{{data.provider+':'+data.name}}">
+                                <div class="top">
+                                    <span class="item-title title-modal">{{data.title}}</span>
+                                    <span class="pull-right text-right item-list-style"
+                                          style="font-size:14px;">{{data.type}}</span>
+                                    <img ng-if="data.type=='VECTOR' && (data.subtype=='Point' || data.subtype=='MultiPoint')"
+                                         ng-src="{{isInSelected(data)?'img/vector-multipoint-selected.svg':'img/vector-multipoint.svg'}}"
+                                         class="pull-right vector-symbol"
+                                         style="margin-top:6px; margin-right:10px;" />
+                                    <img ng-if="data.type=='VECTOR' && (data.subtype=='Polygon' || data.subtype=='MultiPolygon')"
+                                         ng-src="{{isInSelected(data)?'img/vector-poly-selected.svg':'img/vector-poly.svg'}}"
+                                         class="pull-right vector-symbol"
+                                         style="margin-top:6px; margin-right:10px;" />
+                                    <img ng-if="data.type=='VECTOR' && (data.subtype=='LineString' || data.subtype=='MultiLineString')"
+                                         ng-src="{{isInSelected(data)?'img/vector-polyline-selected.svg':'img/vector-polyline.svg'}}"
+                                         class="pull-right vector-symbol"
+                                         style="margin-top:6px; margin-right:10px;" />
+                                    <img ng-if="data.subtype=='Geometry' && data.type!='SENSOR'"
+                                         ng-src="{{isInSelected(data)?'img/vector-multigeometry-selected.svg':'img/vector-multigeometry.svg'}}"
+                                         class="pull-right vector-symbol"
+                                         style="margin-top:6px; margin-right:10px; width:22px;" />
+                                </div>
+                                <div class="bottom">
+                                    <div class="hidden-md hidden-lg">
+                                        <div class="block tooltipicon"
+                                             style="margin-top:0;text-shadow: none;">
+                                            <i class="fa fa-calendar"
+                                               tooltip data-placement="right"
+                                               title="{{data.date | date:'yyyy-MM-dd'}}"></i>
+                                        </div>
+                                        <div class="block tooltipicon"
+                                             style="margin-top:0;text-shadow: none;">
+                                            <i class="fa fa-user"
+                                               tooltip data-placement="right"
+                                               title="{{data.owner}}"></i>
+                                        </div>
+                                    </div>
+                                    <div class="hidden-xs hidden-sm">
+                                        <div class="block">
+                                            <i class="fa fa-calendar"></i>{{data.date | date:'yyyy-MM-dd'}}
+                                        </div>
+                                        <div class="block">
+                                            <i class="fa fa-user"></i>{{data.owner}}
+                                        </div>
+                                    </div>
+                                    <div class="block pull-right" ng-if="data.targetStyle.length==0">
+                                        <i class="fa fa-paint-brush" title="Style SLD"></i>default
+                                    </div>
+                                    <div class="block pull-right" ng-if="data.targetStyle.length==1">
+                                        <i class="fa fa-paint-brush" title="Style SLD"></i>{{truncate(data.targetStyle[0].name,15)}}
+                                    </div>
+                                </div>
+                            </div>
+                            <div class="btn-group pull-right" style="margin-top: -34px;"
+                                 ng-if="data.targetStyle.length>1">
+                                <button type="button"
+                                        class="btn btn-sm btn-default dropdown-toggle"
+                                        data-toggle="dropdown"
+                                        style="margin-right: 6px; margin-top: 4px; padding: 4px; z-index: 1;"
+                                        title="Style SLD">
+                                    <span style="font-size: 11px;">
+                                        <i class="fa fa-paint-brush" style="margin-right:6px;"></i>{{truncate(data.targetStyle[0].name,20)}}
+                                    </span>
+                                    <span class="caret"></span>
+                                </button>
+                                <ul class="dropdown-menu" role="menu" style="font-size: 12px;text-shadow: none;z-index: 2;">
+                                    <li ng-repeat="targetStyle in data.targetStyle"
+                                        ng-click="setTargetStyle(data,$index);">
+                                        <a><span>{{truncate(targetStyle.name,30)}}</span></a>
+                                    </li>
+                                </ul>
+                            </div>
+                        </div>
+                    </div>
+                </div>
+            </div>
+        </div>
+    </div>
+    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
+        <div id="styledMapPreviewForWMTS" style="height: 500px; width:100%;padding: 0;"></div>
+    </div>
+</div>
diff --git a/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_mapcontext.html b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_mapcontext.html
new file mode 100644
index 0000000000..ec9f8e284b
--- /dev/null
+++ b/modules/bundles/exa-webui/grunt/src/views/webservice/wms/step2_mapcontext.html
@@ -0,0 +1,134 @@
+<div class="row" ng-controller="Step1WMTSMapContextController">
+    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-left: 0;padding-right: 0;">
+        <div class="dashboard dashboard-wmts-internal list-style-modal">
+            <div class="navbar sort-navbar" style="margin-bottom: 6px;">
+                <div class="navbar-inner">
+                    <ul class="nav nav-style">
+                        <li ng-click="clickFilter('name')">
+                            <a style="padding:10px;">
+                                <span translate="label.title">Title</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'name' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'name' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                        <li ng-click="clickFilter('date')">
+                            <a style="padding:10px;">
+                                <span translate="service.edit.dashboard.header.date">Date</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'date' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'date' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                        <li ng-click="clickFilter('owner')">
+                            <a style="padding:10px;">
+                                <span translate="service.edit.dashboard.header.owner">Owner</span>
+                                <i class="fa fa-caret-up" ng-if="wrap.ordertype === 'owner' && wrap.orderreverse"></i>
+                                <i class="fa fa-caret-down" ng-if="wrap.ordertype === 'owner' && !wrap.orderreverse"></i>
+                            </a>
+                        </li>
+                        <li class="divider-vertical"></li>
+                    </ul>
+                    <button type="button" ng-click="wrap.ordertype='name';wrap.orderreverse=false" class="btn btn-xs btn-data">
+                        <i class="fa fa-times"></i>
+                    </button>
+                    <button type="button" ng-click="searchVisible= !searchVisible" class="btn btn-xs btn-data">
+                        <i class="fa fa-search"></i>
+                    </button>
+                    <div class="pull-right col-xs-7 col-sm-7 col-md-4 col-lg-5"
+                         style="padding-right:0;padding-left:10px;"
+                         ng-if="searchVisible">
+                        <div style="position:relative;">
+                            <input type="text"
+                                   ng-model="wrap.filtertext"
+                                   class="search-query form-control form-control-fix"
+                                   style="height: 30px;"
+                                   placeholder="{{'label.search' | translate}}" />
+                        </div>
+                    </div>
+                </div>
+            </div>
+            <div class="dash-inner modal-inner-list" style="padding: 0">
+                <div id="list" data-role="list" style="height: 100%;">
+                    <div class="pagination-wrapper pagination-data">
+                        <div class="col-xs-12" style="padding: 0;">
+                            <strong class="col-xs-8" style="padding-right: 0;">
+                                <span class="nb-results pull-left">{{wrap.countdata}}&nbsp;</span>
+                                <span class="nb-results" translate="label.count.mapcontext">available data</span>
+                            </strong>
+                        </div>
+                        <div class="row" style="margin-left: 0; margin-right: 0;">
+                            <div class="col-sm-9" style="padding:0; margin-top: 5px;"
+                                 page-switcher="{page:wrap.currentpage,size:wrap.nbbypage,count:wrap.countdata}"
+                                 on-select-page="displayPage(page)"></div>
+                            <select class="nb-per-page input-small form-control pull-right col-xs-2 "
+                                    style="padding-left: 5px;padding-right: 5px; margin-right: 0; margin-top: 5px;"
+                                    ng-model="wrap.nbbypage">
+                                <option value="5">5</option>
+                                <option value="10">10</option>
+                                <option value="20">20</option>
+                                <option value="50">50</option>
+                                <option value="100">100</option>
+                            </select>
+                        </div>
+                    </div>
+                    <div class="item-list">
+                        <div ng-repeat="context in wrap.dataList">
+                            <div class="item mapcontext"
+                                 ng-class="{'selected':context.id==values.selectedContext.id}"
+                                 ng-click="toggleContextSelection(context)">
+                                <div class="top">
+                                    <span class="item-title title-modal"
+                                          title="{{context.name}}">{{truncate(context.name,30)}}</span>
+                                    <span class="pull-right text-right item-list-style"
+                                          style="font-size:14px;"
+                                          translate="label.mapcontext.system">Map context</span>
+                                </div>
+                                <div class="bottom">
+                                    <div class="hidden-md hidden-lg">
+                                        <div class="block tooltipicon"
+                                             style="margin-top:0;text-shadow: none;">
+                                            <i class="fa fa-calendar"
+                                               tooltip data-placement="right"
+                                               title="{{context.date | date:'yyyy-MM-dd'}}"></i>
+                                        </div>
+                                        <div class="block tooltipicon"
+                                             style="margin-top:0;text-shadow: none;">
+                                            <i class="fa fa-user"
+                                               tooltip data-placement="right"
+                                               title="{{context.userOwner}}"></i>
+                                        </div>
+                                    </div>
+                                    <div class="hidden-xs hidden-sm">
+                                        <div class="block">
+                                            <i class="fa fa-calendar"></i>{{context.date | date:'yyyy-MM-dd'}}
+                                        </div>
+                                        <div class="block">
+                                            <i class="fa fa-user"></i>{{context.userOwner}}
+                                        </div>
+                                    </div>
+                                    <div class="block pull-right">
+                                        <i class="fa fa-paperclip"></i>
+                                            <span ng-if="context.layers == null || context.layers.length == 0"
+                                                  translate="label.no.layers">No layers</span>
+                                            <span ng-if="context.layers.length == 1">
+                                                <span>{{context.layers.length}} </span>
+                                                <span translate="label.layer">layer</span>
+                                            </span>
+                                            <span ng-if="context.layers.length > 1">
+                                                <span>{{context.layers.length}} </span>
+                                                <span translate="label.layers">layers</span>
+                                            </span>
+                                    </div>
+                                </div>
+                            </div>
+                        </div>
+                    </div>
+                </div>
+            </div>
+        </div>
+    </div>
+    <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
+        <div id="mapPreviewMapContextForWMTS" style="height: 500px; width:100%;padding: 0;"></div>
+    </div>
+</div>
\ No newline at end of file
-- 
2.25.1

