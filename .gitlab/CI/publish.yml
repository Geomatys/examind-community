.publish:
  stage: publish
  needs:
    - build
    - "test:hsqldb"
    - "test:postgresql"

.maven-deploy:
  extends: .publish
  script:
    - mvn package source:jar deploy -DskipTests -s $MAVEN_SETTINGS -DaltDeploymentRepository=$DEPLOY_SERVER

maven-deploy-tag:
  extends: .maven-deploy
  only:
    - tags

.docker-push:
  extends: .publish
  variables:
    DOCKER_TAG:
  script:
    # Login to Docker repository
    - mkdir ~/.docker && echo $DOCKER_AUTH_CONFIG > ~/.docker/config.json
    # Build Docker image. Use step by step command, to avoid re-packaging the entire project, which is not needed.
    - >
      mvn -pl :exa-bundle -Pdocker -Ddocker.tag=$DOCKER_TAG
      resources:copy-resources@copy-dockerfile
      dependency:copy@copy-nio-filesystems
      dockerfile:build@build-tomcat-image
    - mvn -pl :exa-bundle -Pdocker -Ddocker.tag=$DOCKER_TAG dockerfile:push
  # Avoid executing default after-script that uses maven.
  after_script:
    - echo 'pushed'

docker-push-latest:
  extends: .docker-push
  variables:
    DOCKER_TAG: latest
  only:
    - master

docker-push-release:
  extends: .docker-push
  variables:
    DOCKER_TAG: $CI_COMMIT_TAG
  only:
    - tags
