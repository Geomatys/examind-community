.publish:
  stage: publish
  needs:
    - build
    - "test:hsqldb"
    - "test:postgresql"

.maven-deploy:
  extends: .publish
  script:
    - mvn package source:jar deploy -DskipTests -s $MAVEN_SETTINGS -DaltDeploymentRepository=$DEPLOY_SERVER

maven-deploy-tag:
  extends: .maven-deploy
  only:
    - tags

maven-deploy-manually:
  extends: .maven-deploy
  when: manual

.docker-push:
  extends: .publish
  variables:
    DOCKER_TAG:
  script:
    # Login to Docker repository
    - mkdir ~/.docker && echo $DOCKER_AUTH_CONFIG > ~/.docker/config.json
    # Build and push
    - mvn package -pl :exa-bundle -Pdocker -Ddocker.tag=$DOCKER_TAG
    - docker push images.geomatys.com/examind/examind-community:$DOCKER_TAG
  # Avoid executing default after-script that uses maven.
  after_script:
    - echo 'pushed'

docker-push-latest:
  extends: .docker-push
  variables:
    DOCKER_TAG: latest
  only:
    - master

docker-push-release:
  extends: .docker-push
  variables:
    DOCKER_TAG: $CI_COMMIT_TAG
  only:
    - tags
